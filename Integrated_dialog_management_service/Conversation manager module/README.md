## **Модуль ConversationManager**

Модуль ConversationManager — это ключевая часть программной архитектуры, ответственная за управление взаимодействиями в чате. Он не только сохраняет все сообщения, обмениваемые пользователями, но и играет критическую роль в помощи моделям искусственного интеллекта для формирования адекватных ответов. С последним обновлением модуля были сохранены все основные функции предыдущих версий, однако добавлена повышенная интеграция с базой данных, что улучшило производительность хранения и обработки истории разговоров. Благодаря оптимизированной архитектуре, ConversationManager теперь более эффективно взаимодействует с другими компонентами системы, обеспечивая лучшую модульность и расширяемость.

**Класс DBConnection**

Класс DBConnection занимается управлением подключением к базе данных. Это основа для работы с данными, включая хранение всех сообщений, обмениваемых в чате. В соответствии с блоком "Dialog db" на схеме, DBConnection обеспечивает не только сохранение данных, но и поддержку операций с большими объёмами данных, что критично для высокой доступности и надёжности системы. Этот класс использует оптимизированные запросы и поддерживает транзакции для обеспечения целостности данных в многопользовательской среде.

**Класс DialogueHistory**

Класс DialogueHistory отвечает за операции с историей диалогов, такие как инициализация новых диалогов, добавление новых сообщений в историю и извлечение сохранённых диалогов. Он работает в тесной интеграции с DBConnection, используя базу данных для эффективного управления данными. Это соответствует функциональности "Conversation manager" на схеме, которая подчёркивает его роль в сохранении и контекстуализации общения для обеспечения непрерывности диалога и улучшения пользовательского опыта через персонализированные и когерентные ответы.

**Интеграция в ConversationManager**

ConversationManager интегрирует функциональность DBConnection и DialogueHistory, создавая унифицированный интерфейс для всех аспектов управления диалогами в системе. Это соответствует блоку "Conversation manager" на схеме и подчёркивает централизованный подход к управлению диалогами. Модуль не только координирует данные и потоки обработки информации, но и обеспечивает масштабируемость системы, позволяя легко добавлять новые функции и улучшения без значительных изменений в основном коде.

---

## **Классы и их функционал**

**Класс DBConnection**

Этот класс управляет подключением к базе данных SQLite и предоставляет методы для выполнения основных операций с базой данных, таких как создание таблицы, выполнение SQL-запросов и закрытие соединения с базой данных.

Методы:

- __init__(self, db_path): Инициализация объекта с указанием пути к файлу базы данных SQLite.
- create_connection(self): Создает соединение с базой данных и инициализирует создание таблицы, если она не существует. Возвращает объект соединения.
- create_table(self, conn): Создает таблицу qa_table в базе данных, если она не существует. Принимает объект соединения с базой данных.
- close_connection(self, conn): Закрывает соединение с базой данных. Принимает объект соединения с базой данных.
- execute(self, query, conn, parameters=()): Выполняет SQL-запрос с возможностью изменения данных. Принимает строку запроса, объект соединения и необязательный кортеж параметров.
- query(self, query, conn, parameters=()): Выполняет SQL-запрос и возвращает результаты. Принимает строку запроса, объект соединения и необязательный кортеж параметров.


**Класс DialogueHistory**

Класс для управления историей диалогов пользователя, хранящихся в базе данных.

Методы:

- __init__(self, db_connection): Инициализация объекта с экземпляром класса DBConnection для подключения к базе данных.
- get_history(self, user_id): Возвращает историю диалогов для указанного пользователя. Принимает уникальный идентификатор пользователя.


**Класс PromptGenerator**

Генератор подсказок для моделей машинного обучения, способный генерировать текст подсказок на основе истории диалога и текущего контекста.

Методы:

- __init__(self): Инициализация генератора подсказок.
- get_prompt(self, question: str, context: str, dialogue_history = " ") -> str: Генерирует подсказку для модели на основе вопроса пользователя, контекста и истории диалога.
- _create_prompt(self, question: str, context: str, dialogue_history = None) -> str: Вспомогательный метод, создающий текст подсказки на основе вопроса, контекста и истории диалога.


**Класс ConversationManager**

Управление диалогами, включая загрузку контекстных моделей и генерацию ответов на запросы.

Методы:

- __init__(self, service_name): Инициализация класса с указанием имени сервиса.
- load_context(self, context) -> None: Загрузка моделей из S3 хранилища.
- predict(self, context, model_input: pd.DataFrame) -> pd.DataFrame: Генерация ответа на запрос.
- handle_query(self, context, user_id: str, query: str, user_history: str, domain_class: str, flag) -> pd.DataFrame: Обработка запроса пользователя.
