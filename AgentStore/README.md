# Техническое описание продукта "Agent Store"

## Концепция продукта

Agent Store — это платформа для создания, настройки и управления агентами на базе LLM с использованием архитектуры Model Context Protocol (MCP), позволяющая пользователям реализовывать блочную архитектуру на уровне WERB-UI через low-code интерфейс.

## Потенциальная архитектура на уровне MVP

```

```

## Предпосылки создания

Рынок AI-агентов быстро развивается, но существует несколько ключевых проблем:

1. Function calling становится архаичным методом взаимодействия агентов с внешними инструментами
2. Реализация мультиагентных систем требует значительных технических компетенций
3. Отсутствие стандартизированных подходов к интеграции различных инструментов
4. Сложность масштабирования и обслуживания индивидуальных функций для каждого агента

MCP (Model Context Protocol) предлагает решение этих проблем, предоставляя стандартизированный интерфейс для взаимодействия LLM с внешними инструментами, но требуется платформа для практической реализации этого подхода.

## Архитектура решения

### Ключевые компоненты системы

1. **Core Engine**
   - MCP Protocol Manager — ядро системы, обеспечивающее коммуникацию между компонентами
   - Authentication & Authorization Service — управление доступом и безопасностью
   - Logging & Monitoring System — система мониторинга и аналитики работы агентов

2. **Agent Builder**
   - Visual Flow Designer — визуальный конструктор агентов
   - Template Library — библиотека готовых шаблонов агентов
   - Configuration Manager — менеджер настройки параметров агентов

3. **Tool Store**
   - Tool Catalog — каталог доступных инструментов
   - Tool Connection Manager — система подключения инструментов
   - Tool Deployment Service — сервис развертывания инструментов

4. **Execution Environment**
   - Agent Runtime — среда выполнения агентов
   - Resource Management — управление вычислительными ресурсами
   - Multi-agent Orchestrator — оркестратор мультиагентных сценариев

5. **Integration Layer**
   - API Gateway — шлюз для внешних интеграций
   - LLM Connector — коннекторы к различным LLM-моделям
   - External Systems Adapters — адаптеры для внешних систем

### Схема взаимодействия компонентов

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   Agent Builder │     │   Tool Store    │     │ Integration Layer│
│                 │     │                 │     │                 │
│ ┌─────────────┐ │     │ ┌─────────────┐ │     │ ┌─────────────┐ │
│ │Visual Designer│◄────►│ │Tool Catalog │ │◄────►│ │LLM Connector│ │
│ └─────────────┘ │     │ └─────────────┘ │     │ └─────────────┘ │
└────────┬────────┘     └────────┬────────┘     └────────┬────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                           Core Engine                            │
│                                                                  │
│ ┌─────────────┐     ┌─────────────┐     ┌─────────────────────┐ │
│ │MCP Protocol │     │Auth & Auth  │     │Logging & Monitoring │ │
│ │  Manager    │     │   Service   │     │      System         │ │
│ └─────────────┘     └─────────────┘     └─────────────────────┘ │
└────────────────────────────┬─────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Execution Environment                       │
│                                                                  │
│ ┌─────────────┐     ┌─────────────┐     ┌─────────────────────┐ │
│ │Agent Runtime│     │  Resource   │     │    Multi-agent      │ │
│ │             │     │ Management  │     │    Orchestrator     │ │
│ └─────────────┘     └─────────────┘     └─────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## Технические особенности реализации

### MCP Implementation

Основой системы является реализация протокола MCP, который обеспечивает стандартизированный интерфейс между агентами и инструментами:

1. **MCP Server Framework**
   - Унифицированный интерфейс для объявления и регистрации инструментов
   - Поддержка коммуникации через HTTP/SSE и stdio
   - Система контекстов для передачи состояния между инструментами

2. **MCP Client Library**
   - Библиотека для подключения LLM к MCP-серверам
   - Поддержка различных LLM-моделей (OpenAI, Anthropic, Gemini и др.)
   - Конвертация ответов LLM в MCP-совместимые вызовы

### Low-Code Tool Builder

Ключевой компонент, позволяющий создавать и настраивать инструменты без глубоких технических знаний:

1. **Инструменты с визуальной конфигурацией**
   - Drag-and-drop интерфейс для создания логики работы инструментов
   - Визуальное определение входных и выходных параметров
   - Готовые шаблоны для типовых инструментов

2. **Автоматическая генерация MCP-серверов**
   - Преобразование визуальных конфигураций в работающие MCP-серверы
   - Автоматическая генерация схем входных/выходных данных
   - Оптимизация серверов под требуемую нагрузку

### Инфраструктура развертывания

Система поддерживает различные варианты развертывания:

1. **Облачная инфраструктура**
   - Автоматическое масштабирование компонентов
   - Балансировка нагрузки для высоконагруженных сценариев
   - Мониторинг и аналитика использования

2. **Локальное развертывание**
   - Контейнеризация компонентов через Docker
   - Оркестрация с использованием Kubernetes
   - Возможность интеграции с корпоративной инфраструктурой

3. **Гибридное развертывание**
   - Комбинирование локальных и облачных компонентов
   - Передача конфиденциальных данных только через локальные компоненты
   - Балансирование нагрузки между облаком и локальной инфраструктурой

## Каталог инструментов (Tool Store)

### Категории инструментов

1. **Поисковые инструменты**
   - Web Search Tool (с поддержкой различных поисковиков)
   - Enterprise Search (для корпоративных документов)
   - Vector Search (для работы с векторными базами данных)

2. **Инструменты для работы с данными**
   - Database Connector (SQL, NoSQL)
   - File System Tool (локальные и облачные хранилища)
   - Data Analysis Tool (обработка и анализ данных)

3. **Интеграционные инструменты**
   - API Connector (взаимодействие с REST API)
   - GitHub Integration (работа с репозиториями и кодом)
   - CRM/ERP Connector (интеграция с бизнес-системами)

4. **Инструменты AI и ML**
   - RAG Engine (Retrieval Augmented Generation)
   - Image Analysis (анализ изображений)
   - Speech Processing (обработка речи)

5. **Утилиты и инфраструктура**
   - Notification Service (уведомления через различные каналы)
   - Scheduling Tool (планирование задач)
   - Authentication Tool (управление доступом)

### Механизм расширения

1. **Tool SDK**
   - Открытый SDK для разработки собственных инструментов
   - Автоматическая генерация MCP-интерфейса
   - Валидация и тестирование инструментов

2. **Tool Marketplace**
   - Платформа для публикации пользовательских инструментов
   - Система рейтингов и отзывов
   - Возможность монетизации инструментов

## Интеграция с LLM

### Поддерживаемые модели

1. **Commercial LLMs**
   - OpenAI (GPT-4, GPT-3.5)
   - Anthropic (Claude 3 Opus, Sonnet, Haiku)
   - Google (Gemini)
   - Microsoft (Azure OpenAI)

2. **Open Source LLMs**
   - Mistral
   - Llama 3
   - Mixtral
   - Phi-3

3. **Local LLMs**
   - Поддержка локально развернутых моделей
   - Оптимизация для различных конфигураций оборудования
   - Интеграция с vLLM, TGI и другими серверами

### Процесс интеграции

Для подключения LLM требуется минимальная конфигурация:

```json
{
  "llm": {
    "provider": "anthropic",
    "model": "claude-3-opus-20240229",
    "api_key": "${ANTHROPIC_API_KEY}"
  },
  "mcp_servers": [
    {
      "name": "search_tools",
      "url": "http://localhost:8080/mcp",
      "authentication": {
        "type": "bearer",
        "token": "${MCP_AUTH_TOKEN}"
      }
    }
  ]
}
```

## Архитектура мультиагентных систем

### Модели взаимодействия агентов

1. **Последовательные цепочки**
   - Выходные данные одного агента передаются следующему
   - Поддержка условного ветвления
   - Возможность циклического возврата

2. **Параллельное выполнение**
   - Одновременная работа нескольких агентов
   - Агрегация результатов через специализированные агенты
   - Масштабирование по мере необходимости

3. **Иерархическая структура**
   - Супервизорные агенты, контролирующие работу подчиненных
   - Делегирование задач и сбор результатов
   - Многоуровневая иерархия агентов

### Оркестрация мультиагентной системы

```
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│  User Input   │────►│  Router Agent │────►│  Task Queue   │
└───────────────┘     └───────────────┘     └───────┬───────┘
                                                   │
                                                   ▼
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│  Result Agent │◄────┤ Orchestrator  │◄────┤ Worker Agents │
└───────┬───────┘     └───────────────┘     └───────────────┘
        │
        ▼
┌───────────────┐
│  User Output  │
└───────────────┘
```

## Пользовательский интерфейс и UX

### Конструктор агентов

1. **Визуальный редактор**
   - Drag-and-drop интерфейс для создания агентов
   - Визуализация потоков данных и логики работы
   - Контекстная справка и подсказки

2. **Управление настройками**
   - Интерфейс для конфигурации параметров агентов
   - Гибкая настройка промптов и системных сообщений
   - Версионирование конфигураций

3. **Тестирование и отладка**
   - Встроенный интерфейс для тестирования агентов
   - Визуализация промежуточных результатов
   - Инструменты для анализа производительности

### Витрина инструментов

1. **Каталог инструментов**
   - Категоризация и поиск инструментов
   - Детальное описание функциональности
   - Рейтинги и отзывы пользователей

2. **Управление подключениями**
   - Интерфейс для настройки подключения к сервисам
   - Менеджер учетных данных и ключей API
   - Мониторинг состояния подключений

### Дашборд мониторинга

1. **Аналитика использования**
   - Статистика вызовов агентов и инструментов
   - Анализ производительности и времени отклика
   - Отчеты об ошибках и проблемах

2. **Управление ресурсами**
   - Мониторинг использования вычислительных ресурсов
   - Настройка лимитов и квот
   - Оптимизация затрат

## Заключение

Agent Store представляет собой комплексное решение для создания, настройки и управления агентами на базе LLM с использованием современной архитектуры Model Context Protocol. Платформа позволяет значительно упростить процесс разработки и внедрения агентных систем, делая их доступными для широкого круга пользователей без глубоких технических знаний.

Ключевые преимущества продукта:
1. Low-code подход к созданию агентов и инструментов
2. Стандартизация взаимодействия через протокол MCP
3. Богатая экосистема готовых инструментов
4. Поддержка различных моделей развертывания
5. Гибкие возможности для расширения и кастомизации

Продукт ориентирован на различные сегменты рынка: от индивидуальных разработчиков и небольших компаний до крупных корпораций, нуждающихся в масштабных решениях для автоматизации процессов с применением ИИ.

---

# Детальный анализ архитектуры проекта "Agent Store"

После тщательного анализа исходного кода проекта, можно представить детальное описание архитектуры системы и взаимодействия ее компонентов:

## 1. Общая архитектура

"Agent Store" реализован как модульное FastAPI-приложение с четким разделением ответственности между компонентами:

- **Конфигурация** (`config.py`) - центральное управление всеми настройками, включая параметры безопасности, подключения к базам данных и интеграции с внешними API
- **База данных** (`db.py`) - инициализация и управление схемой данных через SQLModel
- **API маршрутизация** (`app/api/main.py`) - определение эндпоинтов
- **Модели данных** (`models/base.py` и другие) - представление данных
- **Бизнес-логика** (`core/*`) - реализация функциональности 

Архитектура построена по принципу "плагинов", где многие компоненты (провайдеры моделей, инструменты) могут быть динамически загружены и интегрированы в работающую систему.

## 2. Поток инициализации приложения

Когда приложение запускается:

1. **Загрузка конфигурации** - из файла `config.py` создается экземпляр `settings` с параметрами для безопасности, подключения к БД, внешних API и т.д.
2. **Создание приложения FastAPI** - в `main.py` через `create_app()`
3. **Инициализация БД** - через контекстный менеджер `lifespan`:
   - Создается первичный суперпользователь (если отсутствует)
   - Обновляются навыки (skills) из `managed_tools`
   - Инициализируются провайдеры моделей и их модели
4. **Загрузка инструментов** - через `tool_manager.load_tools()`, который сканирует директорию с инструментами и регистрирует их

## 3. Система провайдеров моделей

Одна из ключевых особенностей - гибкая система для работы с различными LLM через плагинную архитектуру:

```
ModelProviderManager
  |
  |-- Динамически загружает все провайдеры из директории
  |-- Хранит их конфигурации и поддерживаемые модели
  |-- Предоставляет методы для инициализации моделей
```

В файле `model_provider_manager.py` реализован класс `ModelProviderManager`, который:
- Ищет все директории в `app/core/model_providers/` 
- Импортирует из каждой провайдера модуль `config.py`
- Извлекает конфигурацию, список поддерживаемых моделей и функции инициализации
- Предоставляет методы `init_model` и `init_crewai_model` для создания экземпляров моделей
- Обеспечивает единый интерфейс для всех провайдеров через абстракцию

Это позволяет системе легко поддерживать множество различных провайдеров LLM, включая OpenAI, Anthropic, Gemini, Mistral и другие.

## 4. Система графов и построение агентов

В системе реализована сложная архитектура для моделирования взаимодействия агентов через графы различных типов:

### 4.1. Модель графа (`graph.py`)

Граф является фундаментальной структурой для организации агентов:
- `GraphBase` - базовый класс с именем, описанием и конфигурацией
- `Graph` - основная модель для БД с связями к команде и владельцу
- Графы содержат метаданные и конфигурацию, хранимые в формате JSONB

### 4.2. Построение графов (`build.py`)

Система поддерживает различные типы графов агентов:

1. **Иерархические графы** (`create_hierarchical_graph`):
   - Структура "лидер-исполнители", где лидер делегирует задачи
   - Лидер анализирует входящие запросы и решает, кому передать выполнение
   - Включает узел для итоговой сводки (summarizer node)

2. **Последовательные графы** (`create_sequential_graph`):
   - Цепочка агентов, где выход одного служит входом для следующего
   - Каждый агент выполняет свою часть работы и передает результат дальше

3. **Специализированные графы**:
   - `create_chatbot_ragbot_graph` - для чат-ботов и RAG-систем с единственным агентом
   - Поддержка инструментов и прерываний для взаимодействия с пользователем

Функция `generator` организует асинхронную потоковую передачу результатов между компонентами графа и пользователем через SSE (Server-Sent Events).

### 4.3. Узлы графа (`members.py`)

Узлы графа представлены различными типами участников:

- `BaseNode` - базовый класс для всех узлов с общей функциональностью
- `WorkerNode` - исполнитель, обрабатывающий задачи с использованием инструментов
- `SequentialWorkerNode` - специализированный исполнитель для последовательных графов
- `LeaderNode` - координатор, принимающий решения о делегировании задач
- `SummariserNode` - формирует итоговый ответ на основе работы всех узлов
- `ChatBotNode` и `RAGBotNode` - специализированные узлы для чат-ботов и RAG-систем

Состояние графа управляется через `GraphTeamState`, который содержит:
- Историю сообщений
- Текущие сообщения
- Информацию о команде
- Указатель на следующий узел
- Основную задачу

## 5. Система навыков и инструментов

### 5.1. Модель навыков (`skill.py`)

Навыки представляют функциональные возможности, которые могут использовать агенты:

- `SkillBase` - базовый класс с именем, описанием и параметрами
- `Skill` - модель для БД с связями к участникам и владельцу
- Поддержка как управляемых (managed), так и пользовательских навыков
- Хранение учетных данных в зашифрованном виде для безопасного использования API

### 5.2. Менеджер инструментов (`tool_manager.py`)

`ToolManager` отвечает за:
- Динамическую загрузку инструментов из директории `app/core/tools/`
- Преобразование инструментов в унифицированный формат `ToolInfo`
- Управление специальными инструментами, не поддающимися автоматической загрузке
- Стандартизацию входных параметров и учетных данных

Текущая реализация включает внешние инструменты:
- `duckduckgo-search` - поиск в интернете через DuckDuckGo
- `wikipedia` - поиск информации в Wikipedia

## 6. Система обмена сообщениями

В файле `messages.py` реализованы компоненты для обмена данными между частями системы:

- `ChatResponse` - унифицированная модель ответа для всех типов сообщений
- Функция `event_to_response` - преобразует события из графа в формат ответа
- Поддержка различных типов событий:
  - `on_chat_model_stream` - потоковый вывод от LLM
  - `on_chat_model_end` - завершение генерации LLM
  - `on_tool_end` - результат работы инструмента
  - `on_chain_end` - завершение работы цепочки

Система обеспечивает асинхронную потоковую передачу результатов, что позволяет получать промежуточные результаты работы агентов в реальном времени.

## 7. Жизненный цикл выполнения запроса

Полный цикл обработки запроса пользователя включает следующие этапы:

1. **Получение запроса** - через API в формате сообщения
2. **Создание графа агентов** - на основе команды и ее участников
3. **Инициализация состояния** - формирование начального состояния графа
4. **Выполнение графа**:
   - Для иерархического: лидер анализирует запрос и делегирует задачи
   - Для последовательного: запрос последовательно проходит через цепочку агентов
   - Для специализированных: единый агент обрабатывает запрос
5. **Использование инструментов** - агенты могут вызывать инструменты при необходимости
6. **Формирование ответа** - итоговый ответ собирается из результатов работы графа
7. **Потоковая передача** - результаты передаются пользователю по мере их генерации

Ключевой особенностью является поддержка прерываний (`interrupt`), которые позволяют:
- Приостанавливать выполнение для взаимодействия с пользователем
- Запрашивать подтверждение перед использованием инструментов
- Запрашивать дополнительную информацию
- Обрабатывать отказы и корректировки от пользователя

## 8. Интеграция с базами данных

Система использует два типа хранилищ:

1. **PostgreSQL** - для реляционных данных:
   - Полная схема с поддержкой миграций через Alembic
   - Асинхронное взаимодействие через psycopg
   - Использование для хранения контрольных точек LangGraph

2. **Qdrant** (упоминается в конфигурации) - для векторных данных:
   - Хранение эмбеддингов для RAG-систем
   - Коллекция `kb_uploads` для пользовательских документов

## 9. Безопасность и аутентификация

Система включает многоуровневую защиту:

- JWT-токены с настраиваемым сроком действия
- Шифрование учетных данных для инструментов и API-ключей
- CORS-защита с гибкой настройкой разрешенных доменов
- Проверка секретных ключей на использование небезопасных значений по умолчанию
- Хранение учетных данных в зашифрованном виде

## Заключение

"Agent Store" представляет собой сложную, но гибкую и расширяемую систему для создания, настройки и управления LLM-агентами. Архитектура следует принципам:

- **Модульности** - компоненты могут быть заменены или расширены
- **Расширяемости** - поддержка плагинов для провайдеров и инструментов
- **Асинхронности** - потоковая обработка для оптимальной производительности
- **Стандартизации** - единые интерфейсы для различных компонентов

Система эффективно реализует концепцию Model Context Protocol, позволяя создавать сложные мультиагентные системы и оркестрировать их работу без глубоких технических знаний со стороны конечных пользователей.

## Core Engine (Ядро системы)

### MCP Protocol Manager (Менеджер протокола MCP)
- **Стандартизация интерфейсов**: Обеспечивает единый формат взаимодействия между всеми компонентами системы, упрощая интеграцию и расширение
- **Маршрутизация вызовов**: Направляет запросы от агентов к нужным инструментам и компонентам, обеспечивая эффективную коммуникацию
- **Управление контекстами**: Сохраняет и передает контекст взаимодействия между различными инструментами и LLM-моделями

### Auth & Auth Service (Сервис аутентификации и авторизации)
- **JWT-аутентификация**: Обеспечивает безопасный доступ к API с использованием современных токенов JWT
- **Управление доступом**: Контролирует права пользователей и агентов на использование различных функций системы
- **Шифрование учетных данных**: Защищает чувствительную информацию, такую как ключи API и пароли

### Logging & Monitoring (Система логирования и мониторинга)
- **Отслеживание активности**: Регистрирует все действия агентов и пользователей для анализа и аудита
- **Аналитика использования**: Собирает статистику по использованию различных компонентов и функций
- **Мониторинг ошибок**: Выявляет и фиксирует проблемы в работе системы для оперативного реагирования

## Agent Builder (Конструктор агентов)

### Visual Flow Designer (Визуальный конструктор потоков)
- **Интерфейс Drag-and-drop**: Позволяет создавать сложные процессы без программирования
- **Визуализация связей**: Наглядно демонстрирует взаимодействие между агентами и инструментами
- **Валидация потоков**: Проверяет корректность созданных процессов перед их запуском

### Template Library (Библиотека шаблонов)
- **Готовые шаблоны**: Предоставляет набор предварительно настроенных агентов для типовых задач
- **Категоризация**: Организует шаблоны по отраслям и сценариям использования
- **Обмен шаблонами**: Позволяет пользователям делиться своими настройками с сообществом

### Configuration Manager (Менеджер настройки)
- **Управление параметрами**: Настройка поведения агентов и их взаимодействия
- **Версионирование**: Хранение истории изменений конфигурации для возможности отката
- **Валидация настроек**: Проверка корректности параметров перед применением

## Tool Store (Магазин инструментов)

### Tool Catalog (Каталог инструментов)
- **Централизованный каталог**: Единое место для поиска и выбора инструментов
- **Категоризация инструментов**: Организация по типам функциональности
- **Рейтинги и отзывы**: Помощь в выборе наиболее эффективных инструментов

### Tool Connection Manager (Менеджер подключения инструментов)
- **Управление интеграциями**: Настройка подключения к внешним системам и API
- **Хранение учетных данных**: Безопасное управление ключами API и другими параметрами доступа
- **Проверка подключений**: Тестирование работоспособности интеграций

### Tool Deployment Service (Сервис развертывания инструментов)
- **Автоматическое развертывание**: Упрощенная установка и обновление инструментов
- **Управление версиями**: Контроль совместимости различных версий инструментов
- **Масштабирование**: Адаптация ресурсов под нагрузку инструментов

## Integration Layer (Интеграционный слой)

### API Gateway (API-шлюз)
- **Единая точка входа**: Стандартизированный интерфейс для всех внешних интеграций
- **Управление трафиком**: Балансировка нагрузки и защита от перегрузок
- **Преобразование форматов**: Адаптация входящих и исходящих данных к внутренним форматам

### LLM Connector (Коннектор к LLM)
- **Поддержка различных моделей**: Интеграция с популярными моделями от OpenAI, Anthropic, Google и др.
- **Оптимизация вызовов**: Эффективное использование ресурсов при обращении к LLM
- **Управление контекстом**: Подготовка и передача релевантного контекста для моделей

### External Systems Adapters (Адаптеры внешних систем)
- **Готовые интеграции**: Набор коннекторов к популярным системам (CRM, ERP, документооборот)
- **Настраиваемые адаптеры**: Возможность создания собственных коннекторов
- **Трансформация данных**: Преобразование форматов между системами

## Execution Environment (Среда выполнения)

### Agent Runtime (Среда исполнения агентов)
- **GraphBase**: Базовая структура для организации взаимодействия в графах агентов
- **WorkerNode**: Узлы-исполнители для обработки конкретных задач
- **LeaderNode**: Координирующие узлы для управления рабочими процессами
- **SummariserNode**: Агрегирующие узлы для обобщения результатов работы агентов

### Resource Management (Управление ресурсами)
- **PostgreSQL**: Хранение структурированных данных и состояний агентов
- **Qdrant**: Векторное хранилище для эффективного поиска по семантике
- **Оптимизация ресурсов**: Адаптивное распределение вычислительной мощности

### Multi-agent Orchestrator (Оркестратор мультиагентных систем)
- **Hierarchical**: Иерархические структуры с лидерами и исполнителями
- **Sequential**: Последовательные цепочки агентов для поэтапной обработки
- **Specialized**: Специализированные графы для конкретных задач (чат-боты, RAG)

## Жизненный цикл выполнения запроса

1. **Запрос**: Получение исходного запроса от пользователя
2. **Создание графа**: Формирование структуры агентов для обработки запроса
3. **Инициализация**: Подготовка начального состояния и контекста
4. **Выполнение**: Последовательная или параллельная работа агентов
5. **Использование инструментов**: Применение внешних инструментов для выполнения подзадач
6. **Формирование ответа**: Агрегация и структурирование результатов работы
7. **Передача результата**: Предоставление итогового ответа пользователю
